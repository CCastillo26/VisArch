---
title: "VisArch"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

<!-- CSS to widen sidebar label text so descriptions wrap less -->

```{r sidebar-css, echo=FALSE, results='asis'}
cat("

<style>
.section.sidebar .shiny-input-container { width: 100% !important; }

.section.sidebar .radio label,
.section.sidebar .checkbox label {
  display: block;
  width: 100%;
}

.section.sidebar .radio,
.section.sidebar .checkbox {
  margin-left: 0px;
}

details.defn-inline {
  display: block;  
  margin: 0;
  padding: 0;
}

details.defn-inline > summary {
  cursor: pointer;
  list-style: none;
  display: inline-block;
}
details.defn-inline > summary::-webkit-details-marker { display: none; }

details.defn-inline .def-text {
  display: none;
  margin-left: 22px;
  margin-top: 2px;
  font-style: italic;
  color: #555;
}

details.defn-inline[open] .def-text { display: block; }
</style>
")
```


```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(DT)
library(terra)
library(raster)
library(plotly)
```

```{r}
defn <- function(text) {
  tags$details(
    class = "defn-inline",
    tags$summary(tags$strong(term)),
    tags$div(class = "def-text", text)
  )
}
```

Column {data-width=350}
-----------------------------------------------------------------------
### Controls {data-height=650}
```{r}
tags$div(
  style = "max-height: 65vh; overflow-y: auto; padding-right: 10px;",

  selectInput(
    inputId = "method",
    label   = "Preprocessing Method",
    choices = c(
      "Raw" = "raw",
      "Random Forest (Abate et al., 2019)" = "rf",
      "XGBoost" = "xgb"
    ),
    selected = "xgb"
  ),

  tags$div(
  style = "margin-top: 10px; margin-bottom: 6px; color: #666; font-style: italic;",
  "Click a term to show its definition. Click again to hide it."
),
  
  radioButtons(
    inputId = "layer",
    label = "Display Layer",
    choiceNames = list(
      defn_term("Digital Surface Model (DSM)",
        "Digital surface models are elevation surfaces that include ground, vegetation, and structures."
        ),
      defn_term("Digital Terrain Model (DTM)",
        "Digital terrain models are bare-earth elevation surfaces after vegetation removal."
      ),
      defn_term("Canopy Height Model (CHM)",
        "Canopy height models are calculated as DSM minus DTM and highlight vegetation height above the ground.")
      )
    ),
    choiceValues = c("dsm", "dtm", "chm"),
    selected = "dsm"
  ),

  tags$div(
    style = "margin-top: 18px;",
    tags$div(tags$strong("Optional modifications")),
    tags$div(style = "height: 8px;"),

    # Confidence intervals
    conditionalPanel(
      condition = "input.method == 'xgb'",
      checkboxGroupInput(
        inputId = "mods",
        label = NULL,
        choiceNames = list(
          defn_term("Model confidence",
            HTML("Confidence is red, where &lt; 0.60, yellow 0.60–0.80, and green where ≥ 0.80.")
                ))
          )
        ),
        choiceValues = c("conf"),
        selected = character(0)
      )
    ),

    # Viewshed check box
    checkboxGroupInput(
      inputId = "mods_vis",
      label = NULL,
      choiceNames = list(
        tags$div(
          tags$div(tags$strong("Viewsheds")),
          defn("Viewsheds are visibility rasters computed from the DTM for a selected observer location. Black cells indicate terrain predicted to be visible.")
        )
      ),
      choiceValues = c("vis"),
      selected = character(0)
    ),

    # Viewpoint dropdown for viewshed
    conditionalPanel(
      condition = "input.mods_vis && input.mods_vis.indexOf('vis') >= 0",
      tags$div(
        style = "margin-top: 10px;",
        tags$div(tags$strong("Visibility viewpoint")),
        defn("Viewpoints are predefined locations on the site used as the observer position for the viewshed calculation."),
        selectizeInput(
          inputId  = "vp",
          label = NULL,
          choices = c(
            "Central cluster" = "central_cluster",
            "South house/road" = "south_house_road",
            "East outskirts" = "east_outskirts"
          ),
          selected = "central_cluster",
          options  = list(dropdownParent = "body")
      )
    )
  )
)
```


### Metrics
```{r}
metrics <- tibble::tribble(
~Method, ~Class, ~Precision, ~Recall, ~F1,
"RF (Abate et al., 2019)", "Vegetation",  0.68, 0.79, 0.73,
"RF (Abate et al., 2019)", "Other", 0.70, 0.57, 0.63,
"XGBoost (random)", "Vegetation", 0.9892, 0.9955, 0.9924,
"XGBoost (random)", "Other", 0.9513, 0.8904, 0.9198,
"XGBoost (tile)", "Vegetation", 0.9891, 0.9957, 0.9924,
"XGBoost (tile)", "Other", 0.9531, 0.8896, 0.9203
)

DT::renderDataTable({
DT::datatable(
metrics,
options = list(dom = 't', pageLength = 10),
rownames = FALSE
)
})
```


Column {data-width=650}
-----------------------------------------------------------------------
### Ollape
```{r}
renderPlot({
  req(input$method, input$layer)

  method <- as.character(input$method)[1]
  layer  <- as.character(input$layer)[1]

  fname <- file.path("Outputs", paste0(layer, "_", method, "_0p5m.tif"))
  validate(need(file.exists(fname), paste("Missing raster:", fname)))

  r <- terra::rast(fname)
  terra::plot(r, main = paste(toupper(layer), "-", toupper(method)))

  # Optional confidence overlay
  show_conf <- !is.null(input$mods) && ("conf" %in% input$mods) 
  if (show_conf && method == "xgb") {  
    conf_name <- file.path("Outputs", "confclass_xgb_0p5m.tif")

    if (file.exists(conf_name)) {
      conf <- terra::rast(conf_name)
      terra::plot(
        conf,
        col = c("red", "yellow", "green"),
        legend = FALSE,
        alpha = 0.35,
        add = TRUE
      )
    }
  }

  # Optional viewshed overlay
  show_vis <- !is.null(input$mods_vis) && ("vis" %in% input$mods_vis)
  if (show_vis) {  
    req(input$vp)
    vp <- as.character(input$vp)[1]
    vis_name <- file.path("Outputs", paste0("vis_", method, "_", vp, "_0p5m.tif"))

    if (file.exists(vis_name)) {
      vis <- terra::rast(vis_name)
      terra::plot(
        vis,
        col = c(NA, "black"), # 0 = transparent, 1 = black
        legend = FALSE,
        alpha = 0.35,
        add = TRUE
      )
    }
  }
})
```
